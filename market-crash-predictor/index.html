<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Market Crash Predictor</title>
    <script src="../local-env.js"></script>
    <link rel="stylesheet" href="../assets/main.css" />
    <link rel="icon" href="../assets/favicon.svg" type="image/svg+xml" />
  </head>
  <body>
    <div class="page">
      <header>
        <a href="../" class="logo">
          <span class="logo-badge">KL</span>
          <span>Projects</span>
        </a>
        <div class="pill" style="font-weight: 700; color: var(--accent)">Exploration build</div>
      </header>

      <main class="stack">
        <section class="card market-hero">
          <div class="market-hero__text">
            <h1 style="margin-top: 10px; margin-bottom: 12px">Market Crash Predictor</h1>
            <p>
              Simplified cockpit. Live VIX (VIXM) and Brent (CO1) from Twelve Data; USD/JPY newly wired.
            </p>
          </div>

          <div class="market-hero__panel">
            <div class="panel-title" style="margin-bottom: 6px">Risk dial</div>
            <div class="dial">
              <div class="dial__value" id="dial-value">--</div>
              <div class="dial__label" id="dial-label">Current composite probability</div>
              <div class="dial__bar">
                <div class="dial__bar-fill" id="dial-fill"></div>
              </div>
              <div class="dial__legend">
                <span>Calm</span>
                <span>Caution</span>
                <span>Stress</span>
              </div>
            </div>
          </div>
        </section>

        <section>
          <div class="section-header">
            <h2>Signals</h2>
            <div class="pill" id="last-updated">Updates every 30 seconds</div>
            <div class="pill" id="next-refresh">Next refresh in 30s</div>
          </div>
          <div id="crash-mode" class="status-pill">
            <span class="dot"></span>
            <span>Waiting for signals</span>
          </div>
          <div class="signal-list" id="signal-list"></div>
        </section>

      </main>
    </div>
    <script>
      const POLL_INTERVAL_MS = 60000;
      const ENDPOINT = '/api/market-signals';
      const LOCAL_TOKEN = typeof window !== 'undefined' ? window.TWELVE_DATA_KEY : null;
      const IS_STATIC = typeof window !== 'undefined' && (window.location.protocol === 'file:' || window.location.port === '8000');
      let nextRefreshAt = Date.now() + POLL_INTERVAL_MS;

      const SAMPLE_PAYLOAD = {
        asOf: '2025-12-03T09:00:00Z',
        vix: { value: 22.4 },
        brent: { value: 59.3 },
        dxy: { value: 146.2, change1d: 0.35 },
      };

      const renderStatusPill = (state, text) => {
        const pill = document.getElementById('crash-mode');
        if (!pill) return;
        pill.classList.remove('live', 'error', 'loading', 'green', 'yellow', 'orange', 'red');
        pill.classList.add(state);
        pill.querySelector('span:nth-child(2)').textContent = text;
      };

      const setUpdated = (label) => {
        const el = document.getElementById('last-updated');
        if (!el) return;
        el.textContent = label;
      };

      const setNextRefresh = () => {
        const el = document.getElementById('next-refresh');
        if (!el) return;
        const diff = Math.max(0, nextRefreshAt - Date.now());
        const sec = Math.round(diff / 1000);
        el.textContent = sec === 1 ? 'Next refresh in 1s' : `Next refresh in ${sec}s`;
      };

      const activeSignalTemplates = [
        {
          id: 'vix',
          title: 'VIX > 27 (panic) → 30–35 = capitulation',
          eval: (d) => {
            const raw = Number(d?.vix?.value);
            const value = Number.isFinite(raw) && raw > 0 ? raw : null;
            const level = Number.isFinite(value)
              ? value >= 30
                ? 'red'
                : value >= 27
                  ? 'orange'
                  : value >= 20
                    ? 'yellow'
                    : 'green'
              : 'green';
            return {
              level,
              value: Number.isFinite(value) ? `${value.toFixed(1)}` : 'N/A',
              detail: Number.isFinite(value)
                ? value >= 30
                  ? 'Capitulation zone'
                  : value >= 27
                    ? 'Panic band'
                    : 'Calm'
                : 'No data',
            };
          },
        },
        {
          id: 'brent',
          title: 'Brent < 60 USD (58 = next stop)',
          eval: (d) => {
            const value = Number(d?.brent?.value);
            const level = Number.isFinite(value)
              ? value < 58
                ? 'red'
                : value < 60
                  ? 'orange'
                  : value < 65
                    ? 'yellow'
                    : 'green'
              : 'green';
            return {
              level,
              value: Number.isFinite(value) ? `${value.toFixed(2)} USD` : 'N/A',
              detail: Number.isFinite(value)
                ? value < 58
                  ? 'Under 58: capitulation risk'
                  : value < 60
                    ? 'Breaking 60: yellow'
                    : 'Above 60: green'
                : 'No data',
            };
          },
        },
      ];

      const activeFxTemplates = [
        {
          id: 'dxy',
          title: 'USD/JPY spikes',
          eval: (d) => {
            const price = Number(d?.dxy?.value);
            const pct = Number(d?.dxy?.change1d);
            const level = Number.isFinite(pct)
              ? pct >= 0.8
                ? 'red'
                : pct >= 0.5
                  ? 'orange'
                  : pct >= 0.2
                    ? 'yellow'
                    : 'green'
              : Number.isFinite(price) && price >= 150
                ? 'orange'
                : 'green';
            return {
              level,
              value: Number.isFinite(price) ? `${price.toFixed(2)}` : 'N/A',
              detail: Number.isFinite(pct)
                ? `${pct >= 0 ? '+' : ''}${pct.toFixed(2)}% vs USD today`
                : 'No change data',
            };
          },
        },
      ];

      const crashModeLabel = (results) => {
        if (!results || !results.length) return { cls: 'loading', text: 'Waiting on signals' };
        const order = ['green', 'yellow', 'orange', 'red'];
        const worst = results.reduce((max, r) => (order.indexOf(r.level) > order.indexOf(max) ? r.level : max), 'green');
        if (worst === 'red') return { cls: 'red', text: 'Composite risk: RED' };
        if (worst === 'orange') return { cls: 'orange', text: 'Composite risk: ORANGE' };
        if (worst === 'yellow') return { cls: 'yellow', text: 'Composite risk: YELLOW' };
        return { cls: 'green', text: 'Composite risk: GREEN' };
      };

      const levelScore = (level) => {
        if (level === 'green') return 0.1;
        if (level === 'yellow') return 0.4;
        if (level === 'orange') return 0.7;
        if (level === 'red') return 0.95;
        return 0.0;
      };

      const updateDial = (results) => {
        const valueEl = document.getElementById('dial-value');
        const labelEl = document.getElementById('dial-label');
        const fillEl = document.getElementById('dial-fill');
        if (!valueEl || !labelEl || !fillEl) return;

        if (!results || !results.length) {
          valueEl.textContent = '--';
          fillEl.style.width = '0%';
          labelEl.textContent = 'Waiting on VIX';
          return;
        }

        const avg = results.reduce((sum, r) => sum + levelScore(r.level), 0) / results.length;
        const pct = Math.round(avg * 100);
        valueEl.textContent = (avg || 0).toFixed(2);
        fillEl.style.width = `${pct}%`;
        labelEl.textContent = 'Composite from live signals';
      };

      const renderSignals = (data) => {
        const container = document.getElementById('signal-list');
        if (!container) return;
        container.innerHTML = '';

        const liveResults = [...activeSignalTemplates, ...activeFxTemplates].map((tpl) => ({
          ...tpl.eval(data),
          id: tpl.id,
          title: tpl.title,
        }));

        liveResults.forEach((res) => {
          const card = document.createElement('div');
          card.className = `signal-card ${res.level}`;
          card.innerHTML = `
            <div class="signal-head">
              <div class="panel-title">${res.title}</div>
              <span class="signal-chip ${res.level}">${res.level.toUpperCase()}</span>
            </div>
            <div class="signal-meta">
              <div class="signal-value">${res.value}</div>
              <div class="signal-detail">${res.detail}</div>
            </div>
          `;
          container.appendChild(card);
        });

        const overall = crashModeLabel(liveResults);
        renderStatusPill(overall.cls, overall.text);
        updateDial(liveResults);
      };

      const CLIENT_SYMBOLS = {
        vix: ['VIXM', 'VIX', 'VIXY', 'VXX'],
        brent: ['CO1', 'CO1:COM', 'BZ=F', 'BNO', 'USO'],
        dxy: ['USD/JPY', 'USDJPY', 'JPY=X'],
      };

      const fetchMarketDataClient = async () => {
        if (!LOCAL_TOKEN || LOCAL_TOKEN === 'YOUR_TWELVE_DATA_KEY') {
          throw new Error('No local token');
        }
        const symbolList = Array.from(new Set(Object.values(CLIENT_SYMBOLS).flat())).join(',');
        const url = `https://api.twelvedata.com/quote?symbol=${encodeURIComponent(symbolList)}&apikey=${LOCAL_TOKEN}`;
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) {
          const text = await res.text();
          console.warn('Local Twelve Data fetch failed', res.status, text);
          throw new Error('Local fetch failed');
        }
        const json = await res.json();

        const getPrice = (sym) => {
          const item = json[sym];
          if (!item) return null;
          const candidates = [item.price, item.last, item.close];
          for (const c of candidates) {
            const num = Number(c);
            if (Number.isFinite(num) && num > 0) return num;
          }
          return null;
        };

        const getPct = (sym) => {
          const item = json[sym];
          if (!item || typeof item.percent_change === 'undefined') return null;
          const num = Number(item.percent_change);
          return Number.isFinite(num) ? num : null;
        };

        const pickPrice = (arr) => {
          for (const sym of arr) {
            const v = getPrice(sym);
            if (v !== null) return v;
          }
          return null;
        };

        const pickPct = (arr) => {
          for (const sym of arr) {
            const v = getPct(sym);
            if (v !== null) return v;
          }
          return null;
        };

        return {
          asOf: new Date().toISOString(),
          vix: { value: pickPrice(CLIENT_SYMBOLS.vix) },
          brent: { value: pickPrice(CLIENT_SYMBOLS.brent) },
          dxy: { value: pickPrice(CLIENT_SYMBOLS.dxy), change1d: pickPct(CLIENT_SYMBOLS.dxy) },
        };
      };

      const fetchSignals = async () => {
        const useLocalFirst = IS_STATIC && LOCAL_TOKEN && !LOCAL_TOKEN.includes('YOUR');
        if (useLocalFirst) {
          try {
            const data = await fetchMarketDataClient();
            renderSignals(data);
            renderStatusPill('live', 'Updated (local token)');
            setUpdated(`Updated ${new Date().toLocaleTimeString()}`);
          } catch (errLocal) {
            console.warn('Local token fetch failed', errLocal);
            renderSignals(SAMPLE_PAYLOAD);
            renderStatusPill('error', 'Local fetch failed, showing sample data');
            setUpdated('Sample data (local fetch failed)');
          }
          nextRefreshAt = Date.now() + POLL_INTERVAL_MS;
          setNextRefresh();
          return;
        }

        try {
          const res = await fetch(ENDPOINT, { cache: 'no-store' });
          if (!res.ok) {
            if (res.status === 429) throw new Error('Rate limited');
            if (res.status === 404 && LOCAL_TOKEN && !LOCAL_TOKEN.includes('YOUR')) {
              throw new Error('No API route, use local token');
            }
            throw new Error('Bad response');
          }
          const data = await res.json();
          renderSignals(data);
          renderStatusPill('live', 'Updated');
          setUpdated(`Updated ${new Date().toLocaleTimeString()}`);
        } catch (err) {
          console.warn('API fetch failed, trying local token or sample', err);
          if (LOCAL_TOKEN && !LOCAL_TOKEN.includes('YOUR')) {
            try {
              const data = await fetchMarketDataClient();
              renderSignals(data);
              renderStatusPill('live', 'Updated (local token)');
              setUpdated(`Updated ${new Date().toLocaleTimeString()}`);
            } catch (errLocal) {
              console.warn('Local token fetch failed', errLocal);
              renderSignals(SAMPLE_PAYLOAD);
              const msg = err && err.message === 'Rate limited' ? 'Rate limited, showing sample data' : 'Showing sample data';
              renderStatusPill('error', msg);
              setUpdated(msg);
            }
          } else {
            renderSignals(SAMPLE_PAYLOAD);
            const msg = err && err.message === 'Rate limited' ? 'Rate limited, showing sample data' : 'Showing sample data';
            renderStatusPill('error', msg);
            setUpdated(msg);
          }
        }
        nextRefreshAt = Date.now() + POLL_INTERVAL_MS;
        setNextRefresh();
      };

      setUpdated('Loading VIX...');
      fetchSignals();
      setInterval(fetchSignals, POLL_INTERVAL_MS);
      setInterval(setNextRefresh, 1000);
    </script>
  </body>
</html>
