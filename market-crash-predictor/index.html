<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Market Crash Predictor</title>
    <script src="../local-env.js"></script>
    <link rel="stylesheet" href="../assets/main.css" />
    <link rel="icon" href="../assets/favicon.svg" type="image/svg+xml" />
  </head>
  <body>
    <div class="page">
      <header>
        <a href="../" class="logo">
          <span class="logo-badge">KL</span>
          <span>Projects</span>
        </a>
        <div class="pill" style="font-weight: 700; color: var(--accent)">Exploration build</div>
      </header>

      <main class="stack">
        <section class="card market-hero">
          <div class="market-hero__text">
            <h1 style="margin-top: 10px; margin-bottom: 12px">Market Crash Predictor</h1>
            <p>
              A focused cockpit for monitoring macro stress signals, liquidity cracks, and momentum collapses that tend to precede sharp equity drawdowns.
            </p>
          </div>

          <div class="market-hero__panel">
            <div class="panel-title" style="margin-bottom: 6px">Crash risk dial</div>
            <div class="dial">
              <div class="dial__value" id="dial-value">--</div>
              <div class="dial__label" id="dial-label">Current composite probability</div>
              <div class="dial__bar">
                <div class="dial__bar-fill" id="dial-fill"></div>
              </div>
              <div class="dial__legend">
                <span>Calm</span>
                <span>Caution</span>
                <span>Stress</span>
              </div>
            </div>
            <div class="dial-notes">
              <div class="pill" style="background: rgba(255, 209, 102, 0.15); border-color: rgba(255, 209, 102, 0.4); color: var(--warn)">Vol is rising</div>
              <div class="pill" style="background: rgba(255, 123, 123, 0.15); border-color: rgba(255, 123, 123, 0.4); color: var(--danger)">Credit spreads widening</div>
            </div>
          </div>
        </section>

        <section>
          <div class="section-header">
            <h2>Crash triggers in real time</h2>
            <div class="pill" id="last-updated">Updates every 30 seconds</div>
            <div class="pill" id="next-refresh">Next refresh in 30s</div>
          </div>
          <div id="crash-mode" class="status-pill">
            <span class="dot"></span>
            <span>Waiting for signals</span>
          </div>
          <div class="signal-list" id="signal-list"></div>
        </section>

      </main>
    </div>
    <script>
      const POLL_INTERVAL_MS = 60000;
      const ENDPOINT = '/api/market-signals';
      const LOCAL_TOKEN = typeof window !== 'undefined' ? window.TWELVE_DATA_KEY : null;
      const IS_STATIC = typeof window !== 'undefined' && (window.location.protocol === 'file:' || window.location.port === '8000');
      let nextRefreshAt = Date.now() + POLL_INTERVAL_MS;

      const SAMPLE_PAYLOAD = {
        asOf: '2025-12-03T09:00:00Z',
        vix: { value: 28.4 },
        brent: { value: 59.3 },
        dxy: { value: 101.2, change1d: 0.4 },
        asia: { hangSeng: -3.1, nikkei: -0.8, asx: -0.9 },
        europe: { dax: -1.9, obx: -2.1, ftse: -1.4 },
        usa: { spx: -1.2, ndx: -0.9, dow: -0.8 },
      };

      const renderStatusPill = (state, text) => {
        const pill = document.getElementById('crash-mode');
        if (!pill) return;
        pill.classList.remove('live', 'error', 'loading', 'green', 'yellow', 'orange', 'red');
        pill.classList.add(state);
        pill.querySelector('span:nth-child(2)').textContent = text;
      };

      const setUpdated = (label) => {
        const el = document.getElementById('last-updated');
        if (!el) return;
        el.textContent = label;
      };

      const setNextRefresh = () => {
        const el = document.getElementById('next-refresh');
        if (!el) return;
        const diff = Math.max(0, nextRefreshAt - Date.now());
        const sec = Math.round(diff / 1000);
        el.textContent = sec === 1 ? 'Next refresh in 1s' : `Next refresh in ${sec}s`;
      };

      const signalTemplates = [
        {
          id: 'vix',
          title: 'VIX > 27 (panic) → 30–35 = capitulation',
          eval: (d) => {
            const value = Number(d?.vix?.value);
            const level = Number.isFinite(value)
              ? value >= 30
                ? 'red'
                : value >= 27
                  ? 'orange'
                  : value >= 20
                    ? 'yellow'
                    : 'green'
              : 'green';
            return {
              level,
              value: Number.isFinite(value) ? `${value.toFixed(1)}` : 'N/A',
              detail: Number.isFinite(value)
                ? value >= 30
                  ? 'Capitulation zone'
                  : value >= 27
                    ? 'Panic band'
                    : 'Calm'
                : 'No data',
            };
          },
        },
        {
          id: 'brent',
          title: 'Brent < 60 USD (58 = next stop)',
          eval: (d) => {
            const value = Number(d?.brent?.value);
            const level = Number.isFinite(value)
              ? value < 58
                ? 'red'
                : value < 60
                  ? 'orange'
                  : value < 65
                    ? 'yellow'
                    : 'green'
              : 'green';
            return {
              level,
              value: Number.isFinite(value) ? `${value.toFixed(1)} USD` : 'N/A',
              detail: Number.isFinite(value)
                ? value < 58
                  ? 'Under 58: capitulation risk'
                  : value < 60
                    ? 'Breaking 60: yellow'
                    : 'Above 60: green'
                : 'No data',
            };
          },
        },
        {
          id: 'mining',
          title: 'Industrial / mining trend',
          eval: () => ({
            level: 'green',
            value: 'N/A',
            detail: 'Not monitored right now',
          }),
        },
        {
          id: 'dxy',
          title: 'USD / DXY spikes (102+ = commodity pain)',
          eval: (d) => {
            const value = Number(d?.dxy?.value);
            const level = Number.isFinite(value)
              ? value >= 102
                ? 'red'
                : value >= 100.5
                  ? 'orange'
                  : value >= 99
                    ? 'yellow'
                    : 'green'
              : 'green';
            return {
              level,
              value: Number.isFinite(value) ? `${value.toFixed(1)}` : 'N/A',
              detail:
                !Number.isFinite(value)
                  ? 'No data'
                  : level === 'red'
                    ? 'Above 102: pressure on commodities'
                    : level === 'orange'
                      ? 'Dollar surge building'
                      : level === 'yellow'
                        ? 'Dollar firming'
                        : 'Calm',
            };
          },
        },
        {
          id: 'asia',
          title: 'Asia first: Hang Seng –2–4 %, Nikkei red, Australia red',
          eval: (d) => {
            const hs = Number(d?.asia?.hangSeng);
            const nik = Number(d?.asia?.nikkei);
            const asx = Number(d?.asia?.asx);
            const broadRed = Number.isFinite(nik) && Number.isFinite(asx) && nik < 0 && asx < 0;
            const hsFinite = Number.isFinite(hs);
            const level =
              hsFinite || broadRed
                ? hsFinite && hs <= -3 && broadRed
                  ? 'red'
                  : hsFinite && hs <= -2 || broadRed
                    ? 'orange'
                    : hsFinite && hs <= -1 || (Number.isFinite(nik) && nik < 0) || (Number.isFinite(asx) && asx < 0)
                      ? 'yellow'
                      : 'green'
                : 'green';
            return {
              level,
              value: `HS ${Number.isFinite(hs) ? hs.toFixed(1) : 'N/A'} %, Nikkei ${Number.isFinite(nik) ? nik.toFixed(1) : 'N/A'} %, ASX ${Number.isFinite(asx) ? asx.toFixed(1) : 'N/A'} %`,
              detail:
                level === 'red'
                  ? 'Asia in red: high risk'
                  : level === 'orange'
                    ? 'Pressure building in Asia'
                    : level === 'yellow'
                      ? 'Asia soft'
                      : 'No data',
            };
          },
        },
        {
          id: 'europe',
          title: 'Europe –1–3 % (DAX, Oslo, UK)',
          eval: (d) => {
            const dax = Number(d?.europe?.dax);
            const obx = Number(d?.europe?.obx);
            const ftse = Number(d?.europe?.ftse);
            const vals = [dax, obx, ftse].filter((n) => Number.isFinite(n));
            const avg = vals.length ? vals.reduce((a, b) => a + b, 0) / vals.length : null;
            const level =
              avg === null ? 'green' : avg <= -3 ? 'red' : avg <= -2 ? 'orange' : avg <= -1 ? 'yellow' : 'green';
            return {
              level,
              value: `DAX ${Number.isFinite(dax) ? dax.toFixed(1) : 'N/A'} %, OBX ${Number.isFinite(obx) ? obx.toFixed(1) : 'N/A'} %, FTSE ${Number.isFinite(ftse) ? ftse.toFixed(1) : 'N/A'} %`,
              detail:
                level === 'red'
                  ? 'Europe deep red'
                  : level === 'orange'
                    ? 'Europe orange'
                    : level === 'yellow'
                      ? 'Europe yellow'
                      : 'No data',
            };
          },
        },
        {
          id: 'usa',
          title: 'US red + tech no longer holds (Nasdaq/Mag7)',
          eval: (d) => {
            const spx = Number(d?.usa?.spx);
            const ndx = Number(d?.usa?.ndx);
            const level =
              Number.isFinite(spx) && Number.isFinite(ndx)
                ? spx <= -1.5 && ndx <= -1
                  ? 'red'
                  : spx <= -1 || ndx <= -0.8
                    ? 'orange'
                    : spx < 0 || ndx < 0
                      ? 'yellow'
                      : 'green'
                : Number.isFinite(spx)
                  ? spx <= -1.5
                    ? 'red'
                    : spx <= -1
                      ? 'orange'
                      : spx < 0
                        ? 'yellow'
                        : 'green'
                  : Number.isFinite(ndx)
                    ? ndx <= -1
                      ? 'red'
                      : ndx <= -0.8
                        ? 'orange'
                        : ndx < 0
                          ? 'yellow'
                          : 'green'
                    : 'green';
            return {
              level,
              value: `S&P ${Number.isFinite(spx) ? spx.toFixed(1) : 'N/A'} %, Nasdaq ${Number.isFinite(ndx) ? ndx.toFixed(1) : 'N/A'} %`,
              detail:
                level === 'red'
                  ? 'Both red, tech failing'
                  : level === 'orange'
                    ? 'US red, tech weak'
                    : level === 'yellow'
                      ? 'US soft'
                      : 'No data',
            };
          },
        },
      ];

      const crashModeLabel = (results) => {
        const map = Object.fromEntries(results.map((r) => [r.id, r.level]));
        const keyTrip = ['vix', 'brent', 'asia'].every((k) => map[k] === 'red' || map[k] === 'orange');
        if (keyTrip) return { cls: 'red', text: 'CRASH MODE: 1 + 2 + 5 triggered' };
        if (map.brent === 'orange' || map.europe === 'orange' || map.brent === 'red' || map.europe === 'red') {
          return { cls: 'orange', text: 'Orange: oil/Europe under pressure' };
        }
        if (Object.values(map).some((v) => v === 'yellow')) return { cls: 'yellow', text: 'Yellow: watchlist' };
        return { cls: 'green', text: 'Normal / green' };
      };

      const levelScore = (level) => {
        if (level === 'green') return 0.1;
        if (level === 'yellow') return 0.4;
        if (level === 'orange') return 0.7;
        if (level === 'red') return 0.95;
        return 0.0;
      };

      const updateDial = (results) => {
        const valueEl = document.getElementById('dial-value');
        const labelEl = document.getElementById('dial-label');
        const fillEl = document.getElementById('dial-fill');
        if (!valueEl || !labelEl || !fillEl) return;

        if (!results || !results.length) {
          valueEl.textContent = '--';
          fillEl.style.width = '0%';
          labelEl.textContent = 'No data';
          return;
        }

        const avg = results.reduce((sum, r) => sum + levelScore(r.level), 0) / results.length;
        const pct = Math.round(avg * 100);
        valueEl.textContent = (avg || 0).toFixed(2);
        fillEl.style.width = `${pct}%`;
        labelEl.textContent = 'Composite from live signals';
      };

      const renderSignals = (data) => {
        const container = document.getElementById('signal-list');
        if (!container) return;
        container.innerHTML = '';

        const results = signalTemplates.map((tpl) => ({
          ...tpl.eval(data),
          id: tpl.id,
          title: tpl.title,
        }));

        results.forEach((res) => {
          const card = document.createElement('div');
          card.className = `signal-card ${res.level}`;
          card.innerHTML = `
            <div class="signal-head">
              <div class="panel-title">${res.title}</div>
              <span class="signal-chip ${res.level}">${res.level.toUpperCase()}</span>
            </div>
            <div class="signal-meta">
              <div class="signal-value">${res.value}</div>
              <div class="signal-detail">${res.detail}</div>
            </div>
          `;
          container.appendChild(card);
        });

        const overall = crashModeLabel(results);
        renderStatusPill(overall.cls, overall.text);
        updateDial(results);
      };

      const CLIENT_SYMBOLS = {
        vix: ['VIXY', 'VXX'],
        brent: ['BNO', 'USO'],
        dxy: ['DXY', 'UUP'],
        hsi: ['EWH'],
        nikkei: ['EWJ'],
        asx: ['EWA'],
        dax: ['EWG'],
        obx: ['ENOR'],
        ftse: ['EWU'],
        spx: ['SPY'],
        ndx: ['QQQ'],
        dow: ['DIA'],
      };

      const fetchMarketDataClient = async () => {
        if (!LOCAL_TOKEN || LOCAL_TOKEN === 'YOUR_TWELVE_DATA_KEY') {
          throw new Error('No local token');
        }
        const symbolList = Array.from(new Set(Object.values(CLIENT_SYMBOLS).flat())).join(',');
        const url = `https://api.twelvedata.com/quote?symbol=${encodeURIComponent(symbolList)}&apikey=${LOCAL_TOKEN}`;
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) {
          const text = await res.text();
          console.warn('Local Twelve Data fetch failed', res.status, text);
          throw new Error('Local fetch failed');
        }
        const json = await res.json();

        const getPrice = (sym) => {
          const item = json[sym];
          if (!item || typeof item.price === 'undefined') return null;
          const num = Number(item.price);
          return Number.isFinite(num) ? num : null;
        };

        const getChangePct = (sym) => {
          const item = json[sym];
          if (!item || typeof item.percent_change === 'undefined') return null;
          const num = Number(item.percent_change);
          return Number.isFinite(num) ? num : null;
        };

        const pickPrice = (arr) => {
          for (const sym of arr) {
            const v = getPrice(sym);
            if (v !== null) return v;
          }
          return null;
        };

        const pickPct = (arr) => {
          for (const sym of arr) {
            const v = getChangePct(sym);
            if (v !== null) return v;
          }
          return null;
        };

        return {
          asOf: new Date().toISOString(),
          vix: { value: pickPrice(CLIENT_SYMBOLS.vix) },
          brent: { value: pickPrice(CLIENT_SYMBOLS.brent) },
          dxy: { value: pickPrice(CLIENT_SYMBOLS.dxy), change1d: pickPct(CLIENT_SYMBOLS.dxy) },
          asia: {
            hangSeng: pickPct(CLIENT_SYMBOLS.hsi),
            nikkei: pickPct(CLIENT_SYMBOLS.nikkei),
            asx: pickPct(CLIENT_SYMBOLS.asx),
          },
          europe: {
            dax: pickPct(CLIENT_SYMBOLS.dax),
            obx: pickPct(CLIENT_SYMBOLS.obx),
            ftse: pickPct(CLIENT_SYMBOLS.ftse),
          },
          usa: {
            spx: pickPct(CLIENT_SYMBOLS.spx),
            ndx: pickPct(CLIENT_SYMBOLS.ndx),
            dow: pickPct(CLIENT_SYMBOLS.dow),
          },
        };
      };

      const fetchSignals = async () => {
        const useLocalFirst = IS_STATIC && LOCAL_TOKEN && !LOCAL_TOKEN.includes('YOUR');
        if (useLocalFirst) {
          try {
            const data = await fetchMarketDataClient();
            renderSignals(data);
            renderStatusPill('live', 'Updated (local token)');
            setUpdated(`Updated ${new Date().toLocaleTimeString()}`);
          } catch (errLocal) {
            console.warn('Local token fetch failed', errLocal);
            renderSignals(SAMPLE_PAYLOAD);
            renderStatusPill('error', 'Local fetch failed, showing sample data');
            setUpdated('Sample data (local fetch failed)');
          }
          nextRefreshAt = Date.now() + POLL_INTERVAL_MS;
          setNextRefresh();
          return;
        }

        try {
          const res = await fetch(ENDPOINT, { cache: 'no-store' });
          if (!res.ok) {
            if (res.status === 429) throw new Error('Rate limited');
            if (res.status === 404 && LOCAL_TOKEN && !LOCAL_TOKEN.includes('YOUR')) {
              throw new Error('No API route, use local token');
            }
            throw new Error('Bad response');
          }
          const data = await res.json();
          renderSignals(data);
          renderStatusPill('live', 'Updated');
          setUpdated(`Updated ${new Date().toLocaleTimeString()}`);
        } catch (err) {
          console.warn('API fetch failed, trying local token or sample', err);
          if (LOCAL_TOKEN && !LOCAL_TOKEN.includes('YOUR')) {
            try {
              const data = await fetchMarketDataClient();
              renderSignals(data);
              renderStatusPill('live', 'Updated (local token)');
              setUpdated(`Updated ${new Date().toLocaleTimeString()}`);
            } catch (errLocal) {
              console.warn('Local token fetch failed', errLocal);
              renderSignals(SAMPLE_PAYLOAD);
              const msg = err && err.message === 'Rate limited' ? 'Rate limited, showing sample data' : 'Showing sample data';
              renderStatusPill('error', msg);
              setUpdated(msg);
            }
          } else {
            renderSignals(SAMPLE_PAYLOAD);
            const msg = err && err.message === 'Rate limited' ? 'Rate limited, showing sample data' : 'Showing sample data';
            renderStatusPill('error', msg);
            setUpdated(msg);
          }
        }
        nextRefreshAt = Date.now() + POLL_INTERVAL_MS;
        setNextRefresh();
      };

      setUpdated('Loading first datapoint…');
      fetchSignals();
      setInterval(fetchSignals, POLL_INTERVAL_MS);
      setInterval(setNextRefresh, 1000);
    </script>
  </body>
</html>
