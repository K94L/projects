<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Market Crash Predictor</title>
    <script src="../local-env.js"></script>
    <link rel="stylesheet" href="../assets/main.css" />
    <link rel="icon" href="../assets/favicon.svg" type="image/svg+xml" />
  </head>
  <body>
    <div class="page">
      <header>
        <a href="../" class="logo">
          <span class="logo-badge">KL</span>
          <span>Projects</span>
        </a>
        <div class="pill" style="font-weight: 700; color: var(--accent)">Exploration build</div>
      </header>

      <main class="stack">
        <section class="card market-hero">
          <div class="market-hero__text">
            <h1 style="margin-top: 10px; margin-bottom: 12px">Market Crash Predictor</h1>
            <p>
              Simplified cockpit. Live VIX (VIXM) and Brent (CO1) from Twelve Data; USD/JPY newly wired.
            </p>
          </div>

          <div class="market-hero__panel">
            <div class="panel-title" style="margin-bottom: 6px">Risk dial</div>
            <div class="dial">
              <div class="dial__value" id="dial-value">--</div>
              <div class="dial__label" id="dial-label">Current composite probability</div>
              <div class="dial__bar">
                <div class="dial__bar-fill" id="dial-fill"></div>
              </div>
              <div class="dial__legend">
                <span>Calm</span>
                <span>Caution</span>
                <span>Stress</span>
              </div>
            </div>
          </div>
        </section>

        <section>
          <div class="section-header">
            <h2>Signals</h2>
            <div class="pill" id="last-updated">Updates every 30 seconds</div>
            <div class="pill" id="next-refresh">Next refresh in 30s</div>
          </div>
          <div id="crash-mode" class="status-pill">
            <span class="dot"></span>
            <span>Waiting for signals</span>
          </div>
          <div class="signal-list" id="signal-list"></div>
        </section>

      </main>
    </div>
    <script>
      const POLL_INTERVAL_MS = 60000;
      const ENDPOINT = '/api/market-signals';
      const LOCAL_TOKEN = typeof window !== 'undefined' ? window.TWELVE_DATA_KEY : null;
      const IS_STATIC = typeof window !== 'undefined' && (window.location.protocol === 'file:' || window.location.port === '8000');
      let nextRefreshAt = Date.now() + POLL_INTERVAL_MS;

      const SAMPLE_PAYLOAD = {
        asOf: '2025-12-03T09:00:00Z',
        dxy: { value: 146.2, change1d: 0.35 },
      };

      const renderStatusPill = (state, text) => {
        const pill = document.getElementById('crash-mode');
        if (!pill) return;
        pill.classList.remove('live', 'error', 'loading', 'green', 'yellow', 'orange', 'red');
        pill.classList.add(state);
        pill.querySelector('span:nth-child(2)').textContent = text;
      };

      const setUpdated = (label) => {
        const el = document.getElementById('last-updated');
        if (!el) return;
        el.textContent = label;
      };

      const setNextRefresh = () => {
        const el = document.getElementById('next-refresh');
        if (!el) return;
        const diff = Math.max(0, nextRefreshAt - Date.now());
        const sec = Math.round(diff / 1000);
        el.textContent = sec === 1 ? 'Next refresh in 1s' : `Next refresh in ${sec}s`;
      };

      const activeSignalTemplates = [];

      const activeFxTemplates = [
        {
          id: 'dxy',
          title: 'USD/JPY spot',
          eval: (d) => {
            const price = Number(d?.dxy?.value);
            const pct = Number(d?.dxy?.change1d);
            const level = Number.isFinite(pct)
              ? pct >= 0.8
                ? 'red'
                : pct >= 0.5
                  ? 'orange'
                  : pct >= 0.2
                    ? 'yellow'
                    : 'green'
              : Number.isFinite(price) && price >= 150
                ? 'orange'
                : 'green';
            return {
              level,
              value: Number.isFinite(price) ? `${price.toFixed(2)}` : 'N/A',
              detail: Number.isFinite(price) ? `Spot ${price.toFixed(2)}` : 'No data',
            };
          },
        },
      ];

      const crashModeLabel = (results) => {
        if (!results || !results.length) return { cls: 'loading', text: 'Waiting on signals' };
        const order = ['green', 'yellow', 'orange', 'red'];
        const worst = results.reduce((max, r) => (order.indexOf(r.level) > order.indexOf(max) ? r.level : max), 'green');
        if (worst === 'red') return { cls: 'red', text: 'Composite risk: RED' };
        if (worst === 'orange') return { cls: 'orange', text: 'Composite risk: ORANGE' };
        if (worst === 'yellow') return { cls: 'yellow', text: 'Composite risk: YELLOW' };
        return { cls: 'green', text: 'Composite risk: GREEN' };
      };

      const levelScore = (level) => {
        if (level === 'green') return 0.1;
        if (level === 'yellow') return 0.4;
        if (level === 'orange') return 0.7;
        if (level === 'red') return 0.95;
        return 0.0;
      };

      const updateDial = (results) => {
        const valueEl = document.getElementById('dial-value');
        const labelEl = document.getElementById('dial-label');
        const fillEl = document.getElementById('dial-fill');
        if (!valueEl || !labelEl || !fillEl) return;

        if (!results || !results.length) {
          valueEl.textContent = '--';
          fillEl.style.width = '0%';
          labelEl.textContent = 'Waiting on VIX';
          return;
        }

        const avg = results.reduce((sum, r) => sum + levelScore(r.level), 0) / results.length;
        const pct = Math.round(avg * 100);
        valueEl.textContent = (avg || 0).toFixed(2);
        fillEl.style.width = `${pct}%`;
        labelEl.textContent = 'Composite from live signals';
      };

      const renderSignals = (data) => {
        const container = document.getElementById('signal-list');
        if (!container) return;
        container.innerHTML = '';

        const liveResults = [...activeSignalTemplates, ...activeFxTemplates].map((tpl) => ({
          ...tpl.eval(data),
          id: tpl.id,
          title: tpl.title,
        }));

        liveResults.forEach((res) => {
          const card = document.createElement('div');
          card.className = `signal-card ${res.level}`;
          card.innerHTML = `
            <div class="signal-head">
              <div class="panel-title">${res.title}</div>
              <span class="signal-chip ${res.level}">${res.level.toUpperCase()}</span>
            </div>
            <div class="signal-meta">
              <div class="signal-value">${res.value}</div>
              <div class="signal-detail">${res.detail}</div>
            </div>
          `;
          container.appendChild(card);
        });

        const overall = crashModeLabel(liveResults);
        renderStatusPill(overall.cls, overall.text);
        updateDial(liveResults);
      };

      const TWELVE_SYMBOL = 'USD/JPY';

      const fetchMarketDataClient = async () => {
        if (!LOCAL_TOKEN || LOCAL_TOKEN === 'YOUR_TWELVE_DATA_KEY') {
          throw new Error('No Twelve Data key');
        }
        const url = `https://api.twelvedata.com/quote?symbol=${encodeURIComponent(TWELVE_SYMBOL)}&apikey=${LOCAL_TOKEN}`;
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) {
          const text = await res.text();
          console.warn('Twelve Data fetch failed', res.status, text);
          throw new Error(`Twelve Data fetch failed (${res.status})`);
        }
        const json = await res.json();
        if (json && json.status === 'error') {
          throw new Error(json.message || 'Twelve Data error');
        }
        const price = json && typeof json.price !== 'undefined' ? Number(json.price) : Number(json.close);
        const pct = json ? Number(json.percent_change ?? json.change_percentage ?? json.change) : null;
        if (!Number.isFinite(price)) {
          console.warn('Unexpected Twelve Data payload', json);
          throw new Error('Twelve Data response missing data');
        }
        return {
          asOf: new Date().toISOString(),
          dxy: { value: price, change1d: Number.isFinite(pct) ? pct : null },
        };
      };

      const fetchSignals = async () => {
        const canUseLocal = IS_STATIC && LOCAL_TOKEN && !LOCAL_TOKEN.includes('YOUR');
        const hasApiRoute = !IS_STATIC;

        if (canUseLocal) {
          try {
            const data = await fetchMarketDataClient();
            renderSignals(data);
            renderStatusPill('live', 'Updated (local Twelve Data)');
            setUpdated(`Updated ${new Date().toLocaleTimeString()}`);
            nextRefreshAt = Date.now() + POLL_INTERVAL_MS;
            setNextRefresh();
            return;
          } catch (errLocal) {
            const msg = errLocal && errLocal.message ? errLocal.message : 'Local fetch failed';
            console.warn('Local Twelve Data fetch failed', errLocal);
            renderStatusPill('error', msg);
            setUpdated(msg);
            // fall through to API/sample only if we have an API route
            if (!hasApiRoute) {
              renderSignals(SAMPLE_PAYLOAD);
              nextRefreshAt = Date.now() + POLL_INTERVAL_MS;
              setNextRefresh();
              return;
            }
          }
        } else if (!hasApiRoute) {
          setUpdated('No Twelve Data key detected; showing sample data');
          renderSignals(SAMPLE_PAYLOAD);
          renderStatusPill('error', 'Sample data (no key)');
          nextRefreshAt = Date.now() + POLL_INTERVAL_MS;
          setNextRefresh();
          return;
        }

        try {
          const res = await fetch(ENDPOINT, { cache: 'no-store' });
          if (!res.ok) {
            if (res.status === 429) throw new Error('Rate limited');
            throw new Error('Bad response');
          }
          const data = await res.json();
          renderSignals(data);
          renderStatusPill('live', 'Updated');
          setUpdated(`Updated ${new Date().toLocaleTimeString()}`);
        } catch (err) {
          console.warn('API fetch failed, showing sample data', err);
          renderSignals(SAMPLE_PAYLOAD);
          const msg = err && err.message === 'Rate limited' ? 'Rate limited, showing sample data' : 'Showing sample data';
          renderStatusPill('error', msg);
          setUpdated(msg);
        }
        nextRefreshAt = Date.now() + POLL_INTERVAL_MS;
        setNextRefresh();
      };

      setUpdated(IS_STATIC && LOCAL_TOKEN && !LOCAL_TOKEN.includes('YOUR') ? 'Loading from Twelve Data...' : 'Waiting for data...');
      fetchSignals();
      setInterval(fetchSignals, POLL_INTERVAL_MS);
      setInterval(setNextRefresh, 1000);
    </script>
  </body>
</html>
